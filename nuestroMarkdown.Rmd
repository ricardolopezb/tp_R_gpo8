---
title: "Study of Cardiological Patients: Preconditions and Procedures"
author: "Group 8"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---
# Introduction
... 

# Data Analysis
In this section we evaluate different variables in the dataset and show graphs.

## Sex and Age 
```{r, include = FALSE, results='asis'}
library(plotrix)
library(plotly)
library(ggplot2)
library(ggridges)
library(dplyr)
library(hrbrthemes)
library(Hmisc)
library(XML)
library(reshape2)
library(plyr)
library(ggplot2)
library(viridis)

dataset <- read.csv("dataset.csv", sep=";")
x <- cut2(dataset$EDAD, seq(10,90,5))

yes <- dataset$SEXO
displayIngresoSegunEdad<- table(dataset$SEXO,dataset$EDAD)
displayIngresoSegunEdad
textIntervals <- as.character(x)
f <- as.data.frame(table(x))

df <- data.frame(textIntervals, yes)

counts <- ddply(df, .(df$textIntervals, df$yes), nrow)
names(counts) <- c("ageInterval", "Sexo", "Freq")
counts

## pyramid charts are two barcharts with axes flipped

counts$Freq <- ifelse(counts$Sexo == "MASC", -1*counts$Freq, counts$Freq)

pyramid <- ggplot(counts, aes(x = counts$ageInterval, y = counts$Freq, fill = counts$Sexo)) + 
  geom_bar(data = subset(counts, counts$Sexo == "Female"), stat = "identity") +
  geom_bar(data = subset(counts, counts$Sexo == "Male"), stat = "identity") +
  scale_y_continuous(breaks = seq(-60, 60, 10),labels = paste0(as.character(c(seq(60, 0, -10), seq(10, 60, 10))),'')) + 
  coord_flip() + 
  ggtitle("Age distribution by sex") +
  xlab("Age") + ylab("Number Of Patients")+
  scale_fill_discrete(name = "Sex", labels = c("Female", "Male"))+
  theme_bw()

```

```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE}
pyramid
```
In this graph we can observe the sex distribution by age. There is a much higher percentage of men in the dataset and the higher concentration is between 60 and 70 years old.

## Reason for admission

```{r, include = FALSE, results='asis'}
displayIngresoSegunEdad<- table(dataset$MOTIVO.DE.INGRESO,dataset$EDAD)
motivoIngreso<- factor(dataset$MOTIVO.DE.INGRESO)
motivoIngreso

yes <- dataset[which(dataset$MOTIVO.DE.INGRESO == "PROG CORONARIO" | dataset$MOTIVO.DE.INGRESO == "PROG VALV" | dataset$MOTIVO.DE.INGRESO == "PROGRAMADO TAVI" | dataset$MOTIVO.DE.INGRESO == "SCA no SST" | dataset$MOTIVO.DE.INGRESO == "OTRA"),]
yes
x <- cut2(yes$EDAD, seq(10,90,15))


displayIngresoSegunEdad<- table(yes$MOTIVO.DE.INGRESO,yes$EDAD)
displayIngresoSegunEdad
textIntervals <- as.character(x)
f <- as.data.frame(table(x))

df <- data.frame(textIntervals, yes)

counts <- ddply(df, .(df$textIntervals, df$MOTIVO.DE.INGRESO), nrow)
names(counts) <- c("ageInterval", "Motivo", "Freq")
counts

plot <-ggplot(counts, aes(fill=counts$ageInterval, y=counts$Freq, x=counts$Motivo)) + 
  geom_bar(position="stack", stat="identity")+
  ggtitle("Reason for Admission according to Age") +
  xlab("Reason for Admission") + ylab("Frequency")+
  labs(fill = "Age Intervals")+
  scale_x_discrete(labels = c('OTHER','PROG. CORONARY','PROG. VALVE','PROG. TAVI', 'SCA no SST'))

plot

```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
plot
```
---explanation (we left the most important procedures)---

## Procedures

```{r, include = FALSE, results='asis'}
datasetSinNA = dataset[which(dataset$PROCEDIMIENTO != "CIRUGIA, ENDOVALVULA"),]
distributionPlot<-datasetSinNA %>%
  ggplot(aes(x= EDAD, fill = PROCEDIMIENTO)) +
  geom_density(alpha = 0.5) +
  theme_ridges() +
  scale_fill_manual(name = "Procedure:", labels = c("Surgery","Angioplasty","Mitral Valve Rep."), values = c("#10217d","#16c2d5","#3CB371")) +
  theme(legend.position = "top")+
  labs(title="Density of different procedures according to Age",x="Age", y = "Density")
ggtitle("")
```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
distributionPlot
```
---explanation---

## Types of Surgery

```{r, include = FALSE, results='asis'}
subdatasetCirugia <- dataset[which(dataset$PROCEDIMIENTO == "CIRUGIA" & dataset$TIPO.DE.CIRUGIA != "#N/A"),]
tiposDeCirugias<- factor(subdatasetCirugia$TIPO.DE.CIRUGIA)
tablaTiposDeCirugias <- table(tiposDeCirugias)
tablaTiposDeCirugias
tiposDeCirugias

subdatasetCRM = dataset[which(dataset$CRM == "true"),]
numCRM = as.numeric(nrow(subdatasetCRM))
numCRMPura = as.numeric(length(factor(which(subdatasetCRM$TIPO.DE.CIRUGIA == "CRM PURA"))))
percentage<- paste(round((numCRMPura/numCRM)*100), "%", sep="") #Porcentaje de CRMS que son CRM puras
percentage
numCirugia = as.numeric(nrow(subdatasetCirugia))
percentage2<- paste(round((numCRM/numCirugia)*100), "%", sep="") #Porcentaje de Cirugias que son CRM
percentage2
```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
subdatasetCirugia %>% 
  ggplot(aes(y=TIPO.DE.CIRUGIA), position=position_dodge()) + 
  geom_bar( width = 0.85, color = "darkblue", fill = "lightblue") +
  scale_fill_brewer() +
  theme(legend.position="top")+
  ylab("Tipo de Cirugia") +
  xlab("Frecuency")
```
---explanation---

## Complications

```{r, include = FALSE, result = 'asis'}
pacientesATC <- dataset[which(dataset$PROCEDIMIENTO == "ANGIOPLASTIA"),]
tablaAtc = table(pacientesATC$COMPLICACIONES.ANGIOPLASTIA)

prop.table(tablaAtc)

porcentageNoCompAng <- paste(round((tablaAtc[1]/217)*100), "%", sep="")
porcentageCompAng <- paste(round((tablaAtc[2]/217)*100), "%", sep="")

pacientesCRM <- dataset[which(dataset$PROCEDIMIENTO == "CIRUGIA"),]

totalDeCirugia = nrow(pacientesCRM)

cantCompCRM <- nrow(pacientesCRM[which(pacientesCRM$COMPLICACIONES.INMEDIATAS == 1 | pacientesCRM$COMPLICACIONES.TARDIAS == 1),])

cantCompCRM_I <- nrow(pacientesCRM[which(pacientesCRM$COMPLICACIONES.INMEDIATAS == 1 & pacientesCRM$COMPLICACIONES.TARDIAS == 0 ),])
cantCompCRM_T <- nrow(pacientesCRM[which(pacientesCRM$COMPLICACIONES.INMEDIATAS == 0 & pacientesCRM$COMPLICACIONES.TARDIAS == 1),])
cantCompCRM_IyT<- nrow(pacientesCRM[which(pacientesCRM$COMPLICACIONES.INMEDIATAS == 1 & pacientesCRM$COMPLICACIONES.TARDIAS == 1),])

cantidadTotal = cantCompCRM_I + cantCompCRM_IyT + cantCompCRM_T
porComplicaciones = cantidadTotal/totalDeCirugia;
sinComplicaciones = totalDeCirugia - cantidadTotal

tablaCRM = cbind(c(cantidadTotal),c(sinComplicaciones))
tablaCRM
prop.table(tablaCRM)
A <- matrix(nrow=1,ncol=2, c(cantidadTotal,sinComplicaciones), byrow=TRUE)

porcNoCompCrm <- paste(round((as.numeric(A[1,2]/161)*100)), "%", sep="")
porcCompCrm <- paste(round((as.numeric(A[1,1]/161)*100)), "%", sep="")
```
### Angioplasty
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
RegionLabels<-c(porcentageNoCompAng,porcentageCompAng)
pie(tablaAtc, RegionLabels, col = rainbow(length(table(tablaAtc))),main = "Complications in angioplasty patients")
legendLabels = c("No Complications","Complications")
legend("topright", legendLabels, cex = 0.8, fill = rainbow(length(table(tablaAtc))))
```
---explanation---

### Surgery
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
RegionLabels<-c(porcCompCrm,porcNoCompCrm)
pie(tablaCRM, RegionLabels, col = rainbow(length(table(tablaCRM))),main = "Complications in surgery patients")
legendLabels = c("Complicationss","No Complications")
legend("topright", legendLabels, cex = 0.8, fill = rainbow(length(table(tablaCRM))))
```
---explanation and comparison between graphs----

## Number of injuries according to ACC (complex coronary anatomy)
```{r, include = FALSE, result = 'asis'}
subsetNoACC <- dataset[which(dataset$ANATOMIA.CORONARIA.COMPLEJA == 0 & 
                               dataset$NUMERO.DE.LESIONES != "#N/A"),]
frecNumLesionesNoACC <- c(as.numeric(length(factor(
  which(subsetNoACC$NUMERO.DE.LESIONES == 0)))), 
  as.numeric(length(factor(which(subsetNoACC$NUMERO.DE.LESIONES == 1)))), 
  as.numeric(length(factor(which(subsetNoACC$NUMERO.DE.LESIONES == 2)))), 
  as.numeric(length(factor(which(subsetNoACC$NUMERO.DE.LESIONES == 3)))),  
  as.numeric(length(factor(which(subsetNoACC$NUMERO.DE.LESIONES == 4)))), 
  as.numeric(length(factor(which(subsetNoACC$NUMERO.DE.LESIONES == 5))))) 

subsetACC <- dataset[which(dataset$ANATOMIA.CORONARIA.COMPLEJA == 1 & 
                             dataset$NUMERO.DE.LESIONES != "#N/A"),]

frecNumLesionesACC <- c(as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 0)))), 
                        as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 1)))), 
                        as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 2)))), 
                        as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 3)))),  
                        as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 4)))), 
                        as.numeric(length(factor(which(subsetACC$NUMERO.DE.LESIONES == 5))))) 


cols1<- c("0 Injuries", "1 Injury", "2 Injuries", "3 Injuries", "4 Injuries", "5 Injuries")
rows1<- c("ACC", "No ACC")

procedACC_data <- data.frame(frecNumLesionesACC,frecNumLesionesNoACC, row.names = cols1)

colnames(procedACC_data)[1]<-"ACC"
colnames(procedACC_data)[2]<-"No ACC"



```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
barplot(t(as.matrix(procedACC_data)),beside=TRUE,main="Injuries according to ACC",xlab="Injuries", ylab="Frequency", col=c("red", "lightblue"),
        legend.text = colnames(procedACC_data),args.legend=list(cex=0.75,x = "top"))
```
---explanation---

## Procedure according affected vessels

```{r, include = FALSE, result = 'asis'}
subdatasetVasosAfectados = dataset[which(dataset$Resumen.Coronariopatia !="#N/A" & dataset$Resumen.Coronariopatia !="TCI solo"),]
displayVasosProced <- table(subdatasetVasosAfectados$PROCEDIMIENTO,subdatasetVasosAfectados$Resumen.Coronariopatia)
displayVasosProced

subdatasetVasosAfectados
vasosCirugiaAngioplastia <- subdatasetVasosAfectados[which(subdatasetVasosAfectados$PROCEDIMIENTO == "CIRUGIA" | subdatasetVasosAfectados$PROCEDIMIENTO == "ANGIOPLASTIA"),]
unVaso<-vasosCirugiaAngioplastia[which(vasosCirugiaAngioplastia$Resumen.Coronariopatia == "1 vaso"),]
dosVasos<-vasosCirugiaAngioplastia[which(vasosCirugiaAngioplastia$Resumen.Coronariopatia == "2 vasos"),]
tresVasos<-vasosCirugiaAngioplastia[which(vasosCirugiaAngioplastia$Resumen.Coronariopatia == "3 vasos"),]

coronopatia<- c(c("One vessel", "One vessel"),c("Two vessels", "Two vessels"), c("Three vessels", "Three vessels"))
procedimiento<- c("Surgery", "Angioplasty","Surgery", "Angioplasty","Surgery", "Angioplasty")
valores<- c(nrow(unVaso[which(unVaso$PROCEDIMIENTO == "CIRUGIA"),]),nrow(unVaso[which(unVaso$PROCEDIMIENTO == "ANGIOPLASTIA"),]),nrow(dosVasos[which(dosVasos$PROCEDIMIENTO == "CIRUGIA"),]),nrow(dosVasos[which(dosVasos$PROCEDIMIENTO == "ANGIOPLASTIA"),]),nrow(tresVasos[which(tresVasos$PROCEDIMIENTO == "CIRUGIA"),]),nrow(tresVasos[which(tresVasos$PROCEDIMIENTO == "ANGIOPLASTIA"),]))
dataVasosProced <- data.frame(procedimiento,coronopatia,valores)
```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
ggplot(dataVasosProced, aes(fill=procedimiento, y=valores ,x=procedimiento)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  ggtitle("Procedure according affected vessels") +
  facet_wrap(~coronopatia,nrow = 1) +
  theme_ipsum() +
  theme(legend.position="none") +
  xlab("")
```
---explanation----

## Relation between TAD, TAS (Arterial Tension) and clamping time
```{r, include = FALSE, result = 'asis'}
subdatasetNoAngioplastia = dataset[which(dataset$PROCEDIMIENTO != "ANGIOPLASTIA"),]
subdatasetTiempoClampeo = subdatasetNoAngioplastia[which(subdatasetNoAngioplastia$TIEMPO.DE.CLAMPEO != "#N/A"),]
subdatasetTiempoClampeoTAD = subdatasetTiempoClampeo[which(subdatasetTiempoClampeo$TAD.INGRESO.RCV != "#N/A"),]
subdatasetTiempoClampeoTAS = subdatasetTiempoClampeo[which(subdatasetTiempoClampeo$TAS.INGRESO.RCV != "#N/A"),]


tiempoDeClampeoTad = subdatasetTiempoClampeoTAD$TIEMPO.DE.CLAMPEO
tiempoDeClampeoTas = subdatasetTiempoClampeoTAS$TIEMPO.DE.CLAMPEO
tad = subdatasetTiempoClampeoTAD$TAD.INGRESO.RCV[which(subdatasetTiempoClampeoTAD$TAD.INGRESO.RCV != "#N/A")]
tas = subdatasetTiempoClampeoTAS$TAS.INGRESO.RCV[which(subdatasetTiempoClampeoTAS$TAS.INGRESO.RCV != "#N/A")]
```
### TAD and clamping time

```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
plot(tad,tiempoDeClampeoTad)
modeltad = lm(tiempoDeClampeoTad~tad)
abline(modeltad)
```

### TAS and clamping time

```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
plot(tas,tiempoDeClampeoTas)
modeltas = lm(tiempoDeClampeoTas~tas)
abline(modeltas)
```
evaluar si sacar estos graficos o cambiarlos para poner algo que aporte mas info. Esto esta mal :)

## Procedure Frequency by Risk Factor

```{r, include= FALSE,results='asis'}
riskCirugia <- dataset[which(dataset$PROCEDIMIENTO == "CIRUGIA"),] 
frecRiesgoCirugia<- c(as.numeric(length(factor(which(riskCirugia$EPOC == 1)))), as.numeric(length(factor(which(riskCirugia$DIABETES == 1)))), as.numeric(length(factor(which(riskCirugia$HIPERTENSION.PULMONAR == 1)))), as.numeric(length(factor(which(riskCirugia$OBESIDAD.MORBIDA == 1)))),  as.numeric(length(factor(which(riskCirugia$EDAD >65)))), as.numeric(length(factor(which(riskCirugia$FEY <50))))) 
cols<- c("EPOC", "Diabetes", "Lung Hypertension", "Morbid Obesity", "Age above 65", "FEY less than 50")
rows<- c("Cirugia", "Angioplastia")
riskATC <- dataset[which(dataset$PROCEDIMIENTO == "ANGIOPLASTIA"),]
frecRiesgoATC<- c(as.numeric(length(factor(which(riskATC$EPOC == 1)))), as.numeric(length(factor(which(riskATC$DIABETES == 1)))), as.numeric(length(factor(which(riskATC$HIPERTENSION.PULMONAR == 1)))), as.numeric(length(factor(which(riskATC$OBESIDAD.MORBIDA == 1)))),  as.numeric(length(factor(which(riskATC$EDAD >65)))), as.numeric(length(factor(which(riskATC$FEY <50))))) 

procedRisksData<-data.frame(frecRiesgoCirugia,frecRiesgoATC, row.names = cols)
colnames(procedRisksData)[1]<-"Surgery"
colnames(procedRisksData)[2]<-"Angioplasty"

procedRisksData
```
```{r fig.width=6, fig.height=6, fig.align='center',echo=FALSE,warning=FALSE}
barplot(t(as.matrix(procedRisksData)),beside=TRUE,main="Procedure Frequency by Risk Factor",xlab="Risk Factors", ylab="Frequency", col=c("lightblue", "red"),
        legend.text = colnames(procedRisksData),args.legend=list(cex=0.75,x = "top"))
```
----Explanation----

## {.unnumbered}